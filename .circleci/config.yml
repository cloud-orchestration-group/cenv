version: 2

volumes: &volumes
    name: Ensuring application volumes
    command: |
        mkdir -p ./data
        mkdir -p ./lib

jobs:
    deploy-docker-latest:
        machine: true
        steps:
            - checkout
            - run: *volumes
            - run:
                name: Deploy latest Docker image
                command: ./build/docker/deploy_latest.sh

    deploy-docker-version:
        machine: true
        steps:
            - checkout
            - run: *volumes
            - run:
                name: Deploy versioned Docker image
                command: ./build/docker/deploy_version.sh

    deploy-pip:
        docker:
            - image: python:3.8
        steps:
            - checkout
            - run:
                name: Deploy Pip package
                command: ./build/pip/deploy.sh

    deploy-docs:
        docker:
            - image: python:3.8
        steps:
            - run:
                name: Install core dependencies
                command: |
                    apt-get update
                    apt-get install -y git g++ gcc make

            - checkout

            - run:
                name: Install documentation dependencies
                command: pip install --no-cache-dir -r ./docs/requirements.txt

            - run:
                name: Deploy documentation
                command: |
                    git config --global user.name "CircleCI ( ${CIRCLE_USERNAME} )"
                    git config --global user.email "${CIRCLE_USERNAME}@${CIRCLE_BRANCH}"
                    ./build/docs/deploy.sh git@github.com:zimagi/zimagi.git "${CIRCLE_BRANCH}"

    update-helm-chart:
        docker:
            - image: python:3.9
        steps:
            - checkout

            - run:
                name: Clone repository charts
                command: git clone git@github.com:zimagi/charts

            - run:
                name: Update helm chart zimagi version
                command: |
                    echo "Get actual docker version"
                    VERSION=$(cat app/settings/version.py | awk '{print $3}' | tr -d '[:space:]' | tr -d "'")

                    echo "Install requirements of python app"
                    pip install -r ./charts/.circleci/version_updater/requirements.txt

                    echo "Update version of zimagi chart"
                    python ./charts/.circleci/version_updater/version_updater.py -c ./charts/charts/zimagi -t $VERSION

                    echo "Push changes in repo charts"
                    git config --global user.name "CircleCI ( ${CIRCLE_USERNAME} )"
                    git config --global user.email "${CIRCLE_USERNAME}@${CIRCLE_BRANCH}"
                    git add ./charts/charts/zimagi/Chart.yaml ./charts/charts/zimagi/values.yaml
                    git commit --signoff -m "Update version of zimagi (docker push)"
                    git push origin master

workflows:
    version: 2
    deploy:
        jobs:
            - deploy-docker-latest:
                filters:
                    tags:
                        ignore: /.*/
                    branches:
                        only: main
            - deploy-docker-version:
                filters:
                    tags:
                        only: /^.*/
                    branches:
                        ignore: /.*/
            - deploy-pip:
                filters:
                    tags:
                        only: /^.*/
                    branches:
                        ignore: /.*/
            - deploy-docs:
                filters:
                    branches:
                        only:
                            - main
                            - docs
            - update-helm-chart:
                filters:
                    tags:
                        only: /^.*/
                    branches:
                        ignore: /.*/
                requires:
                    - deploy-docker-version