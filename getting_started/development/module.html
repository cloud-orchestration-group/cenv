

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>1.2.3. Creating a module &mdash; Zimagi 0.5.1 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/override.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="1.3. Zimagi Environment" href="../environment.html" />
    <link rel="prev" title="1.2.2. Dockerized Development" href="docker.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #021026" >
          
            
          <div class="logo"><span class="sr-only">Zimagi</span></div>

          

          

          
          <a href="../../readme.html" class="icon icon-home"><span class="name">Zimagi</span>
          
          </a>
          <span class="description">Distributed Data Processing Platform
            
              
              
              <span class="version">
                (0.5.1)
              </span>
              
            
          </span>


          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://zimagi.com">Zimagi Site</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/zimagi/zimagi/">GitHub Project</a></li>
</ul>
<p class="caption"><span class="caption-text">Documentation</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../readme.html">1. Getting Started with Zimagi</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../about.html">1.1. About Zimagi</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="readme.html">1.2. Zimagi Development Options</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="vagrant.html">1.2.1. Vagrant Development</a></li>
<li class="toctree-l3"><a class="reference internal" href="docker.html">1.2.2. Dockerized Development</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">1.2.3. Creating a module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#initializing-zimagi">1.2.3.1. Initializing Zimagi</a></li>
<li class="toctree-l4"><a class="reference internal" href="#developing-module-functionality">1.2.3.2. Developing module functionality</a></li>
<li class="toctree-l4"><a class="reference internal" href="#defining-a-data-model">1.2.3.3. Defining a data model</a></li>
<li class="toctree-l4"><a class="reference internal" href="#defining-data-importation">1.2.3.4. Defining data importation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#defining-commands">1.2.3.5. Defining commands</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">1.2.3. Creating a module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#initializing-zimagi">1.2.3.1. Initializing Zimagi</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#creating-a-module-skeleton">1.2.3.1.1. Creating a module skeleton</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adding-a-module-to-zimagi">1.2.3.1.2. Adding a module to Zimagi</a></li>
<li class="toctree-l4"><a class="reference internal" href="#creating-a-local-remote">1.2.3.1.3. Creating a local remote</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#developing-module-functionality">1.2.3.2. Developing module functionality</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#defining-roles">1.2.3.2.1. Defining roles</a></li>
<li class="toctree-l4"><a class="reference internal" href="#data-mixins">1.2.3.2.2. Data mixins</a></li>
<li class="toctree-l4"><a class="reference internal" href="#command-mixins">1.2.3.2.3. Command mixins</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#defining-a-data-model">1.2.3.3. Defining a data model</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#defining-data-base-objects">1.2.3.3.1. Defining data_base objects</a></li>
<li class="toctree-l4"><a class="reference internal" href="#defining-data-objects">1.2.3.3.2. Defining data objects</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#defining-data-importation">1.2.3.4. Defining data importation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#python-import-code">1.2.3.4.1. Python import code</a></li>
<li class="toctree-l4"><a class="reference internal" href="#loading-items">1.2.3.4.2. Loading items</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#defining-commands">1.2.3.5. Defining commands</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#import-commands">1.2.3.5.1. Import commands</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../environment.html">1.3. Zimagi Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hosting.html">1.4. Zimagi Hosting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../help.html">1.5. Getting Help with Zimagi</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html">1.6. Contributing to Zimagi</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../design_architecture/readme.html">2. Zimagi Design and Architecture</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../design_architecture/concepts.html">2.1. Zimagi Concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../design_architecture/technologies.html">2.2. Zimagi Technologies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../design_architecture/systems.html">2.3. Zimagi Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../design_architecture/interface.html">2.4. Zimagi Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../design_architecture/services/readme.html">2.5. Zimagi Services</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../design_architecture/services/cli.html">2.5.1. Zimagi Command Line Interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_architecture/services/command.html">2.5.2. Zimagi Command API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_architecture/services/data.html">2.5.3. Zimagi Data API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_architecture/services/scheduler.html">2.5.4. Zimagi Scheduler</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_architecture/services/worker.html">2.5.5. Zimagi Worker</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../design_architecture/data/readme.html">2.6. Zimagi Data Types</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../design_architecture/data/environment.html">2.6.1. Zimagi Environment Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_architecture/data/host.html">2.6.2. Zimagi Environment Host Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_architecture/data/user.html">2.6.3. Zimagi User Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_architecture/data/group.html">2.6.4. Zimagi Group Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_architecture/data/log.html">2.6.5. Zimagi Log Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_architecture/data/module.html">2.6.6. Zimagi Module Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_architecture/data/state.html">2.6.7. Zimagi State Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_architecture/data/configuration.html">2.6.8. Zimagi Configuration Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_architecture/data/schedule.html">2.6.9. Zimagi Schedule Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_architecture/data/notification.html">2.6.10. Zimagi Notification Data</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../design_architecture/plugins/readme.html">2.7. Zimagi Plugins</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../design_architecture/plugins/module.html">2.7.1. Zimagi Module Plugin</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_architecture/plugins/task.html">2.7.2. Zimagi Task Plugin</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../design_architecture/commands/readme.html">2.8. Zimagi Commands</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../design_architecture/commands/help.html">2.8.1. Zimagi Help Commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_architecture/commands/environment.html">2.8.2. Zimagi Environment and Connection Management Commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_architecture/commands/service.html">2.8.3. Zimagi Service Commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_architecture/commands/data.html">2.8.4. Zimagi Data Management Commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_architecture/commands/orchestration.html">2.8.5. Zimagi Orchestration and Workflow Commands</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../design_architecture/orchestration/readme.html">2.9. Zimagi Orchestration Components</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../design_architecture/orchestration/config.html">2.9.1. Zimagi Configuration Component</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_architecture/orchestration/group.html">2.9.2. Zimagi Group Component</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_architecture/orchestration/run.html">2.9.3. Zimagi Run Components</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_architecture/orchestration/destroy.html">2.9.4. Zimagi Destroy Components</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_architecture/orchestration/profile.html">2.9.5. Zimagi Profile Component</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../design_architecture/extending.html">2.10. Extending Zimagi</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../readme.html"><span>Zimagi</span> - <span class="description">Distributed Data Processing Platform</span></a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          















<div class="breadcrumbs" role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../readme.html">Docs</a> &raquo;</li>
        
          <li><a href="../readme.html">1. Getting Started with Zimagi</a> &raquo;</li>
        
          <li><a href="readme.html">1.2. Zimagi Development Options</a> &raquo;</li>
        
      <li>1.2.3. Creating a module</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/getting_started/development/module.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="creating-a-module">
<h1>1.2.3. Creating a module<a class="headerlink" href="#creating-a-module" title="Permalink to this headline">¶</a></h1>
<p>This tutorial will demonstrate to developers how to create a Zimagi module.
As an example, we will create a module that obtains data from a public data
source provided by the United States National Oceanic and Atmospheric
Administration (NOAA).</p>
<p>This module is available in a public GitHub repository at:</p>
<blockquote>
<div><p><a class="reference external" href="https://github.com/zimagi/module-noaa-stations">https://github.com/zimagi/module-noaa-stations</a></p>
</div></blockquote>
<p>Our module development will be performed locally, which provides an interactive
environment for enhancing and testing feature as they are added.</p>
<p>The example we will work through utilizes a large collection of CSV files, each
of which is regular in form.  At a particular URL, there are subdirectories
named as years, and within each of those directories are many individual CSV
files, each containing information about data from one weather station during
that year.</p>
<p>Inside each of these CSV files, rows contain a mixture of information about the
station itself, such as its name, altitude and latitude, and information about
the observation, such as temperature, humidity, visibility, precipitation, and
so on.</p>
<div class="section" id="initializing-zimagi">
<h2>1.2.3.1. Initializing Zimagi<a class="headerlink" href="#initializing-zimagi" title="Permalink to this headline">¶</a></h2>
<p>The very first step you should perform is to clone the Zimagi repository
itself onto your local system.  That repository is available at:</p>
<blockquote>
<div><p><a class="reference external" href="https://github.com/zimagi/zimagi">https://github.com/zimagi/zimagi</a></p>
</div></blockquote>
<p>Suppose that you have cloned Zimagi itself into <code class="docutils literal notranslate"><span class="pre">$HOME/git/zimagi</span></code> on your local
system.  Let us name this as <code class="docutils literal notranslate"><span class="pre">$ZDIR</span></code> for purposes of this tutorial.  You may
wish to copy <code class="docutils literal notranslate"><span class="pre">$ZDIR/vagrant/config.default.yml</span></code> to <code class="docutils literal notranslate"><span class="pre">$ZDIR/vagrant/config.yml</span></code>
and modify the settings within the new <code class="docutils literal notranslate"><span class="pre">config.yml</span></code> file.  In most cases, the
default settings will be fine, and this is not necessary.</p>
<p>In this tutorial, a shell prompt showing the leaf of the working directory is used
to help you orient the path you might be working within.  Within <cite>$ZDIR</cite> you simply
need to launch the Vagrant configuration, i.e.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(zimagi)$ vagrant up  # Will take a few minutes to setup
(zimagi)$ vagrant ssh
</pre></div>
</div>
<p>This will put you inside a Vagrant hosted Zimagi console where you may run
commands.</p>
<div class="section" id="creating-a-module-skeleton">
<h3>1.2.3.1.1. Creating a module skeleton<a class="headerlink" href="#creating-a-module-skeleton" title="Permalink to this headline">¶</a></h3>
<p>Before making a module available within Zimagi, you need to create a GitHub
repository that contains a skeleton for a module.  The goal here will be to
create a local clone of the module you are developing underneath the <code class="docutils literal notranslate"><span class="pre">$ZDIR</span></code>
directory, but it needs to exist in a basic form first.</p>
<p>All that your module strictly needs is a file called <code class="docutils literal notranslate"><span class="pre">zimagi.yml</span></code> at its root.
This file, in its minimal version, only has to define a name for the module.
For example, within our demonstration module:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(module-noaa-stations)$ cat zimagi.yml
name: &quot;noaa-stations&quot;
</pre></div>
</div>
<p>Now we are ready to load the module into Zimagi and enhance it.</p>
</div>
<div class="section" id="adding-a-module-to-zimagi">
<h3>1.2.3.1.2. Adding a module to Zimagi<a class="headerlink" href="#adding-a-module-to-zimagi" title="Permalink to this headline">¶</a></h3>
<p>Within the Vagrant shell, it is commonly useful to check the environment to
verify that changes and configurations you intend to make have been peformed.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">vagrant</span><span class="p">)</span> <span class="n">zimagi</span> <span class="n">env</span> <span class="n">get</span>
</pre></div>
</div>
<p>Initially, this will contain only the default environment, but we can now add
the module skeleton we created.  For the example, we can run the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">vagrant</span><span class="p">)</span> <span class="n">zimagi</span> <span class="n">module</span> <span class="n">add</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">zimagi</span><span class="o">/</span><span class="n">module</span><span class="o">-</span><span class="n">noaa</span><span class="o">-</span><span class="n">stations</span><span class="o">.</span><span class="n">git</span>
<span class="p">(</span><span class="n">vagrant</span><span class="p">)</span> <span class="n">zimagi</span> <span class="n">env</span> <span class="n">get</span>
</pre></div>
</div>
<p>Adjust the GitHub URL as needed to point to your repository.  Notice that at
this point we are only using the <code class="docutils literal notranslate"><span class="pre">https://</span></code> URL rather than the <code class="docutils literal notranslate"><span class="pre">git&#64;</span></code> URL
since the Vagrant shell does not have SSH credentials configured.  This is not
a problem, and we will enhance the connection just below.</p>
<p>Within your local terminal, you can now see where the module has been cloned:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(zimagi)$ cd lib/modules/default/
(default)$ ls noaa-stations
</pre></div>
</div>
<p>In the minimal version, this will contain only the <code class="docutils literal notranslate"><span class="pre">zimagi.yml</span></code>, shown above,
but you may have created a <code class="docutils literal notranslate"><span class="pre">LICENSE</span></code> or a <code class="docutils literal notranslate"><span class="pre">README</span></code> or other repository
contents.</p>
</div>
<div class="section" id="creating-a-local-remote">
<h3>1.2.3.1.3. Creating a local remote<a class="headerlink" href="#creating-a-local-remote" title="Permalink to this headline">¶</a></h3>
<p>Add a remote to the working Zimagi repo for the module by running the following.
We assume that the system you are working on has established SSH credentials
with GitHub, and you are able to run authenticated commands.  Within your
local terminal shell:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">zimagi</span><span class="p">)</span> <span class="n">git</span> <span class="n">remote</span> <span class="n">add</span> <span class="n">noaa</span> <span class="n">git</span><span class="nd">@github</span><span class="o">.</span><span class="n">com</span><span class="p">:</span><span class="n">zimagi</span><span class="o">/</span><span class="n">module</span><span class="o">-</span><span class="n">noaa</span><span class="o">-</span><span class="n">stations</span><span class="o">.</span><span class="n">git</span>
<span class="p">(</span><span class="n">zimagi</span><span class="p">)</span> <span class="n">git</span> <span class="n">push</span> <span class="n">noaa</span>  <span class="c1"># Nothing has changed yet, but this will now work</span>
</pre></div>
</div>
<p>Periodically, within the Zimagi Vagrant shell, you will integrate new
functionality by running:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">vagrant</span><span class="p">)</span> <span class="c1"># Pull changes from GitHub:</span>
<span class="p">(</span><span class="n">vagrant</span><span class="p">)</span> <span class="n">zimagi</span> <span class="n">module</span> <span class="n">save</span> <span class="n">noaa</span><span class="o">-</span><span class="n">stations</span>
<span class="p">(</span><span class="n">vagrant</span><span class="p">)</span> <span class="n">zimagi</span> <span class="n">makemigrations</span>
</pre></div>
</div>
<p>From this point forward, you can (and probably should) work within the module
clone that is located at <code class="docutils literal notranslate"><span class="pre">$ZDIR/lib/modules/default/noaa-stations</span></code> (or whatever
leaf path corresponds to the name you gave to your module.  Notice that this
directory matches the <code class="docutils literal notranslate"><span class="pre">name</span></code> key defined inside the module’s <code class="docutils literal notranslate"><span class="pre">zimagi.yml</span></code>
file rather than the repository name itself.  In this example, the repository is
named <code class="docutils literal notranslate"><span class="pre">module-noaa-stations</span></code> while the module name is <code class="docutils literal notranslate"><span class="pre">noaa-stations</span></code>; but
either name can be whatever you like.</p>
</div>
</div>
<div class="section" id="developing-module-functionality">
<h2>1.2.3.2. Developing module functionality<a class="headerlink" href="#developing-module-functionality" title="Permalink to this headline">¶</a></h2>
<p>The Zimagi system will scan a number of YAML configuration files to provide
capabilities within a module.  Most of the requirements are driven by the various
keys inside these YAML files, but an organization into directories and filenames
is helpful for identifying the location of various definitions.</p>
<p>Configurations will live inside the <code class="docutils literal notranslate"><span class="pre">spec/</span></code> directory of the module repository.</p>
<div class="section" id="defining-roles">
<h3>1.2.3.2.1. Defining roles<a class="headerlink" href="#defining-roles" title="Permalink to this headline">¶</a></h3>
<p>We would like to define roles for differing kinds of users who have different
capabilities within the system.  Those are ideally placed in <code class="docutils literal notranslate"><span class="pre">spec/roles.yml</span></code>,
for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">noaa</span><span class="o">-</span><span class="n">stations</span><span class="p">)</span> <span class="n">cat</span> <span class="n">spec</span><span class="o">/</span><span class="n">roles</span><span class="o">/</span><span class="n">yml</span>
<span class="n">roles</span><span class="p">:</span>
  <span class="n">noaa</span><span class="o">-</span><span class="n">admin</span><span class="p">:</span> <span class="n">Administer</span> <span class="n">NOAA</span> <span class="n">weather</span> <span class="n">data</span>
  <span class="n">viewer</span><span class="p">:</span> <span class="n">User</span> <span class="n">who</span> <span class="n">can</span> <span class="n">view</span> <span class="n">weather</span> <span class="n">data</span>
</pre></div>
</div>
<p>We will use these roles later on to control what actions given named roles may
perform.  As many roles as we like may be defined, and they may be named however
we like.  However, using names with dashes or underscores are generally easier
to enter into other configuration files since quoting is not needed when spaces
are not used.</p>
</div>
<div class="section" id="data-mixins">
<h3>1.2.3.2.2. Data mixins<a class="headerlink" href="#data-mixins" title="Permalink to this headline">¶</a></h3>
<p>Zimagi allows you to configure “mixins” which are a kind of boilerplate that
avoids repeating the same definitions that are used in multiple places.  Mixins
might either be <code class="docutils literal notranslate"><span class="pre">data_mixins</span></code> or <code class="docutils literal notranslate"><span class="pre">command_mixins</span></code>.  We can define a
<code class="docutils literal notranslate"><span class="pre">data_mixin</span></code> in a fashion similar to this.  The same name (in this case
“station”) is used at several levels, but with somewhat different meanings in
the different positions.  Let us look at an example defined within
<code class="docutils literal notranslate"><span class="pre">spec/data/station.yml</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data_mixins</span><span class="p">:</span>
  <span class="n">station</span><span class="p">:</span>
    <span class="n">class</span><span class="p">:</span> <span class="n">StationMixin</span>
    <span class="n">fields</span><span class="p">:</span>
      <span class="n">station</span><span class="p">:</span>
        <span class="nb">type</span><span class="p">:</span> <span class="s2">&quot;@django.ForeignKey&quot;</span>
        <span class="n">relation</span><span class="p">:</span> <span class="n">station</span>
        <span class="n">options</span><span class="p">:</span>
          <span class="s2">&quot;null&quot;</span><span class="p">:</span> <span class="n">true</span>
          <span class="n">on_delete</span><span class="p">:</span> <span class="s2">&quot;@django.PROTECT&quot;</span>
          <span class="n">editable</span><span class="p">:</span> <span class="n">false</span>
</pre></div>
</div>
<p>In essence, what we define in the mixin is a database column that has attributes,
but is used in multiple places to define a foreign key relation.  The Django data
type identifies the relationship, with YAML keys <code class="docutils literal notranslate"><span class="pre">type</span></code> and <code class="docutils literal notranslate"><span class="pre">relation</span></code>
indicating the primary table.  The <code class="docutils literal notranslate"><span class="pre">options</span></code> values correspond to database
table properties in a straightforward way.</p>
<p>Explicitly specifying a <code class="docutils literal notranslate"><span class="pre">class</span></code> name, as is done above, is optional (and is
not used for any real externally-facing purposes, only in code generation).
Mixins may also have inheritance relationships by specifying a <code class="docutils literal notranslate"><span class="pre">base</span></code>, but that
is not used in this example.</p>
</div>
<div class="section" id="command-mixins">
<h3>1.2.3.2.3. Command mixins<a class="headerlink" href="#command-mixins" title="Permalink to this headline">¶</a></h3>
<p>Commands, which we look at below, may also utilize mixins to save repeated
boilerplate.  For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">command_mixins</span><span class="p">:</span>
  <span class="c1"># Generate methods on other classes</span>
  <span class="n">station</span><span class="p">:</span>
    <span class="n">class</span><span class="p">:</span> <span class="n">StationCommandMixin</span>
    <span class="n">meta</span><span class="p">:</span>
      <span class="c1"># Name used in commands (not required to be same as table)</span>
      <span class="c1"># Ref: mixin_name</span>
      <span class="n">station</span><span class="p">:</span>
        <span class="c1"># Link back to dynamic class station</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">station</span>
        <span class="c1"># Positive integer (lowest is highest priority)</span>
        <span class="n">priority</span><span class="p">:</span> <span class="mi">1</span>
</pre></div>
</div>
<p>Again we define a name <code class="docutils literal notranslate"><span class="pre">station</span></code> that might be mixed into. <code class="docutils literal notranslate"><span class="pre">class</span></code> remains
optional and generally internal.  The key elements is the a data source.  The
<code class="docutils literal notranslate"><span class="pre">priority</span></code> given simply expresses the order in which help on commands is shown.</p>
</div>
</div>
<div class="section" id="defining-a-data-model">
<h2>1.2.3.3. Defining a data model<a class="headerlink" href="#defining-a-data-model" title="Permalink to this headline">¶</a></h2>
<p>For a module to do something useful, we need to configure its <em>data model</em>.
This expresses, in a somewhat Django-centric way, a mapping onto relational
database tables where the data is actually stored.</p>
<p>For this example project, there are two data types used; this is very similar
to the way you might define multiple tables in an RDBMS (and in fact maps to
exactly that “under the hood”).  We have <code class="docutils literal notranslate"><span class="pre">stations</span></code> and <code class="docutils literal notranslate"><span class="pre">observations</span></code>.
The definitions of these kinds of data are contained in the files:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">$ZDIR/lib/modules/default/noaa-stations/station.yml</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$ZDIR/lib/modules/default/noaa-stations/observations.yml</span></code></p></li>
</ul>
</div></blockquote>
<p>This choice follows a natural pattern, but is not required.  We could put the
definitions in any files we wanted, as long as they live in the module
directory hierarchy and have the extension <code class="docutils literal notranslate"><span class="pre">.yml</span></code>.  The structure of these
two files is very similar, although somewhat more is defined within
<code class="docutils literal notranslate"><span class="pre">station.yml</span></code> since some mixins and <strong>bases</strong> (more on that soon) are defined
in <code class="docutils literal notranslate"><span class="pre">station.yml</span></code> and hence do not need to be duplicated in
<code class="docutils literal notranslate"><span class="pre">observations.yml</span></code>.</p>
<p>Within a data model, we typically define a top-level key <code class="docutils literal notranslate"><span class="pre">data_base</span></code> and
another under the key <code class="docutils literal notranslate"><span class="pre">data</span></code>.  While as this module is organized, each of
<code class="docutils literal notranslate"><span class="pre">station.yml</span></code> and <code class="docutils literal notranslate"><span class="pre">observations.yml</span></code> have their own top level keys, we could
perfectly well put all of this in the same file if we preferred.  For example,
as actually organized, we have:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># in station.yml</span>
<span class="n">data</span><span class="p">:</span>
  <span class="n">station</span><span class="p">:</span>
    <span class="c1"># ... more info ...</span>

<span class="c1"># in observations.yml</span>
<span class="n">data</span><span class="p">:</span>
  <span class="n">observation</span><span class="p">:</span>
    <span class="c1"># ... more info ...</span>
</pre></div>
</div>
<p>This is a decision of the module developer; a different module might choose
instead, for example, to have:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># in data-model.yml (not a file in this module)</span>
<span class="n">data</span><span class="p">:</span>
  <span class="n">station</span><span class="p">:</span>
    <span class="c1"># ... more info ...</span>
  <span class="n">observation</span><span class="p">:</span>
    <span class="c1"># ... more info ...</span>
</pre></div>
</div>
<div class="section" id="defining-data-base-objects">
<h3>1.2.3.3.1. Defining data_base objects<a class="headerlink" href="#defining-data-base-objects" title="Permalink to this headline">¶</a></h3>
<p>In this module, the “abstract” base object <code class="docutils literal notranslate"><span class="pre">station</span></code> is used by concrete data
objects (including one called <code class="docutils literal notranslate"><span class="pre">station</span></code>).  Let us look at that definition,
here contained in <code class="docutils literal notranslate"><span class="pre">station.yml</span></code> (but again, it could live elsewhere if you
prefer):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data_base</span><span class="p">:</span>
  <span class="n">station</span><span class="p">:</span>
    <span class="c1"># Every model (usually) based on resource</span>
    <span class="n">class</span><span class="p">:</span> <span class="n">StationBase</span>
    <span class="n">base</span><span class="p">:</span> <span class="n">resource</span>
    <span class="n">mixins</span><span class="p">:</span> <span class="p">[</span><span class="n">station</span><span class="p">]</span>
    <span class="n">id_fields</span><span class="p">:</span> <span class="p">[</span><span class="n">number</span><span class="p">]</span>
    <span class="n">meta</span><span class="p">:</span>
      <span class="c1"># Number alone is probably unique, demonstrate compound key</span>
      <span class="n">unique_together</span><span class="p">:</span> <span class="p">[</span><span class="n">number</span><span class="p">,</span> <span class="n">name</span><span class="p">]</span>
      <span class="c1"># Updates must define station</span>
      <span class="n">scope</span><span class="p">:</span> <span class="n">station</span>
</pre></div>
</div>
<p>This has several notable elements.  The field named <code class="docutils literal notranslate"><span class="pre">number</span></code> is specific to
the data we are working with.  The NOAA data defines a CSV column called
<code class="docutils literal notranslate"><span class="pre">STATION</span></code> which is a special number weather services use for identification,
and also a column called <code class="docutils literal notranslate"><span class="pre">NAME</span></code> that is a verbose description of the weather
station.  We have used names that are more mnemonic for us in calling them
<code class="docutils literal notranslate"><span class="pre">number</span></code> and <code class="docutils literal notranslate"><span class="pre">name</span></code> in the module, but we are free to use any names
whatsoever.</p>
<p>We are declaring in the <code class="docutils literal notranslate"><span class="pre">data_base</span></code> that the combination of <code class="docutils literal notranslate"><span class="pre">number``and</span>
<span class="pre">``name</span></code> will define a unique identifier, but only <code class="docutils literal notranslate"><span class="pre">number</span></code> is used as the ID
for queries.  In this particular dataset, probably <code class="docutils literal notranslate"><span class="pre">number</span></code> alone will be
unique, and the more verbose description <code class="docutils literal notranslate"><span class="pre">name</span></code> might actually change over
multiple years.  However, the <code class="docutils literal notranslate"><span class="pre">unique_together</span></code> key is given a list containing
both mostly for illustration of the possibility.</p>
</div>
<div class="section" id="defining-data-objects">
<h3>1.2.3.3.2. Defining data objects<a class="headerlink" href="#defining-data-objects" title="Permalink to this headline">¶</a></h3>
<p>With the scaffolding in place, we can define an actual data object.  Let us
quickly notice something about the <code class="docutils literal notranslate"><span class="pre">observation</span></code> object before presenting the
full <code class="docutils literal notranslate"><span class="pre">station</span></code> object:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Inside observation.yml</span>
<span class="n">data</span><span class="p">:</span>
  <span class="n">observation</span><span class="p">:</span>
    <span class="n">class</span><span class="p">:</span> <span class="n">Observation</span>
    <span class="c1"># Observation extends Station base data model</span>
    <span class="n">base</span><span class="p">:</span> <span class="n">station</span>
</pre></div>
</div>
<p>Because an observation represents a “child table”, it is based on the parent
<code class="docutils literal notranslate"><span class="pre">data_base</span></code> object <code class="docutils literal notranslate"><span class="pre">station</span></code>.  Let us look at (almost) the entire definition
for the <code class="docutils literal notranslate"><span class="pre">station</span></code> object:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">:</span>
  <span class="c1"># Actual data models turned into tables</span>
  <span class="c1"># Fields &#39;name&#39;, &#39;id&#39;, &#39;updated&#39;, &#39;created&#39; implicitly</span>
  <span class="c1"># created by base resource (id/updated/created internal)</span>
  <span class="n">station</span><span class="p">:</span>
    <span class="n">class</span><span class="p">:</span> <span class="n">Station</span>
    <span class="c1"># Environment extends resource in Zimagi core</span>
    <span class="n">base</span><span class="p">:</span> <span class="n">environment</span>
    <span class="c1"># Primary key (not necessarily externally facing)</span>
    <span class="n">id_fields</span><span class="p">:</span> <span class="p">[</span><span class="n">number</span><span class="p">,</span> <span class="n">name</span><span class="p">]</span>
    <span class="c1"># Unique identifier within the scope</span>
    <span class="n">key</span><span class="p">:</span> <span class="n">number</span>
    <span class="n">roles</span><span class="p">:</span>
      <span class="c1"># Redundant to specify &#39;admin&#39;</span>
      <span class="n">edit</span><span class="p">:</span> <span class="p">[</span><span class="n">noaa</span><span class="o">-</span><span class="n">admin</span><span class="p">,</span> <span class="n">admin</span><span class="p">]</span>
      <span class="c1"># Editors are automatically viewers</span>
      <span class="c1"># Public does not require authentication</span>
      <span class="c1"># (viewer will authenticate if public were not listed)</span>
      <span class="n">view</span><span class="p">:</span> <span class="p">[</span><span class="n">viewer</span><span class="p">,</span> <span class="n">public</span><span class="p">]</span>
    <span class="n">fields</span><span class="p">:</span>
      <span class="n">number</span><span class="p">:</span>
        <span class="nb">type</span><span class="p">:</span> <span class="s2">&quot;@django.CharField&quot;</span>
        <span class="n">options</span><span class="p">:</span>
          <span class="s2">&quot;null&quot;</span><span class="p">:</span> <span class="n">false</span>
          <span class="n">max_length</span><span class="p">:</span> <span class="mi">255</span>
          <span class="c1"># editable is default (not specified)</span>
      <span class="n">lat</span><span class="p">:</span>
        <span class="c1"># In degrees</span>
        <span class="nb">type</span><span class="p">:</span> <span class="s2">&quot;@django.FloatField&quot;</span>
        <span class="n">options</span><span class="p">:</span>
          <span class="s2">&quot;null&quot;</span><span class="p">:</span> <span class="n">true</span>
      <span class="c1"># &#39;lon&#39; and &#39;elevation&#39; defined in same manner as &#39;lat&#39;</span>
      <span class="n">meta</span><span class="p">:</span>
        <span class="n">unique_together</span><span class="p">:</span> <span class="p">[</span><span class="n">number</span><span class="p">,</span> <span class="n">name</span><span class="p">]</span>
        <span class="c1"># Display ordered by elevation and number</span>
        <span class="n">ordering</span><span class="p">:</span> <span class="p">[</span><span class="n">elevation</span><span class="p">,</span> <span class="n">number</span><span class="p">]</span>
        <span class="c1"># Fuzzy string search</span>
        <span class="n">search_fields</span><span class="p">:</span> <span class="p">[</span><span class="n">number</span><span class="p">,</span> <span class="n">name</span><span class="p">]</span>
</pre></div>
</div>
<p>A number of things are happening in this definition.  We create an actual
<code class="docutils literal notranslate"><span class="pre">station</span></code> object, with a corresponding RDBMS table.  The table will not yet
have a way to be populated with this definition, but this determines its schema
and Zimagi will create the empty table based on this.</p>
<p>We can define a primary key as <code class="docutils literal notranslate"><span class="pre">id_fields</span></code> and an access identifier as
<code class="docutils literal notranslate"><span class="pre">key</span></code>. These may often be the same, but need not be, as the example
illustrates.</p>
<p>A crucial element is that this is where we can define access permissions to this
data object.  These <code class="docutils literal notranslate"><span class="pre">roles</span></code> correspond to those we created earlier.  The
special roles <em>admin</em> and <em>public</em> are always available, but any other strings
may be used to define various permissions (assuming they are defined as roles).
The role <em>admin</em> will always have all permissions, but we list it here to
illustrate its existence.</p>
<p>The crucial element in defining a data element is the fields it will contain.
The key <code class="docutils literal notranslate"><span class="pre">fields</span></code> lets us list these,  along with data types and properties.
Fields can have whatever names are convenient for us; we will see later how they
are translated from whatever names are used in the underlying data sources
(quite likely, those underlying data sources use a variety of different names,
and Zimagi will present a more unified interface to the data).</p>
<p>Data types are provided using Django data definition types, quoted.  For example,
latitude (named <code class="docutils literal notranslate"><span class="pre">lat</span></code> by us) is a <code class="docutils literal notranslate"><span class="pre">&#64;django.FloatField</span></code> type.  Within each
field, we may define a few constrains, such as its NULL-ability and, for a
string, its maximum length.</p>
<p>We may define a few special attributes of the data object.  For example, by
default, queries of this data will be sorted by elevation then by (station)
number.  This is again chosen for illustration, not any specific business need
within this particular module; in other cases, an order may be relevant.  Search
fields allows for substring search within Zimagi queries.</p>
</div>
</div>
<div class="section" id="defining-data-importation">
<h2>1.2.3.4. Defining data importation<a class="headerlink" href="#defining-data-importation" title="Permalink to this headline">¶</a></h2>
<p>To perform import of data within Zimagi, we will also have to define commands
within the YAML configuration files, but it is worth looking at the Python code
needed to do the concrete data acquisition first.</p>
<p>The means by which we do this is defined in the code
<code class="docutils literal notranslate"><span class="pre">$ZDIR/lib/modules/default/noaa-stations/plugins/source/noaa_stations.py</span></code>.
This name—minus the <code class="docutils literal notranslate"><span class="pre">.py</span></code> part, is indicated in the file
<code class="docutils literal notranslate"><span class="pre">$ZDIR/lib/modules/default/noaa-stations/spec/plugins/source.yml</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plugin</span><span class="p">:</span>
  <span class="n">source</span><span class="p">:</span>
    <span class="c1"># Identify providers across modules</span>
    <span class="n">providers</span><span class="p">:</span>
      <span class="n">noaa_stations</span><span class="p">:</span>
        <span class="n">requirement</span><span class="p">:</span>
          <span class="n">min_year</span><span class="p">:</span>
            <span class="nb">type</span><span class="p">:</span> <span class="nb">int</span>
            <span class="n">help</span><span class="p">:</span> <span class="n">The</span> <span class="n">beginning</span> <span class="n">year</span> <span class="n">to</span> <span class="n">query</span>
          <span class="n">max_year</span><span class="p">:</span>
            <span class="nb">type</span><span class="p">:</span> <span class="nb">int</span>
            <span class="n">help</span><span class="p">:</span> <span class="n">The</span> <span class="n">end</span> <span class="n">year</span> <span class="n">to</span> <span class="n">query</span>
        <span class="n">option</span><span class="p">:</span>
          <span class="n">station_ids</span><span class="p">:</span>
            <span class="nb">type</span><span class="p">:</span> <span class="nb">list</span>
            <span class="n">help</span><span class="p">:</span> <span class="n">A</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">station</span> <span class="n">IDs</span> <span class="n">to</span> <span class="n">include</span>
            <span class="n">default</span><span class="p">:</span> <span class="n">null</span>
</pre></div>
</div>
<p>Within this configuration, beyond indicating what Python file to incorporate,
we define required and optional fields to make available to that Python code.
In this example, the Python code will <em>always</em> have access to integer values for
<code class="docutils literal notranslate"><span class="pre">min_year</span></code> and <code class="docutils literal notranslate"><span class="pre">max_year</span></code> and <em>might</em> have access to a list value named
<code class="docutils literal notranslate"><span class="pre">station_ids</span></code>.  Field names must be spelled as valid Python identifiers.</p>
<p>While some Python code is needed here, it mostly follows a fairly strictly
stereotyped pattern.  Obviously, the code needed will vary based on the data
format of the source and any authentication system that might be required to
access it.  For this module example, we chose data that is publicly available
and is contained in a fairly straightforward CSV format.</p>
<p>The bulk of this importer is a class called <code class="docutils literal notranslate"><span class="pre">Provider</span></code> that needs to define
three methods, <code class="docutils literal notranslate"><span class="pre">.item_columns()</span></code>, <code class="docutils literal notranslate"><span class="pre">.load_items()</span></code>, and <code class="docutils literal notranslate"><span class="pre">.load_item()</span></code>.
Exactly what other Python libraries you might use are very specific to the
nature of the data source.  The Zimagi runtime environment <strong>will</strong> make
available <em>Pandas</em> and <em>requests</em>, which are certainly two of those that you
will use very often.</p>
<p>If you need to utilize other libraries, such as database adapters or data format
readers you will need to add them to the Zimagi runtime by <strong>[TODO]</strong>.</p>
<div class="section" id="python-import-code">
<h3>1.2.3.4.1. Python import code<a class="headerlink" href="#python-import-code" title="Permalink to this headline">¶</a></h3>
<p>Let us look at <code class="docutils literal notranslate"><span class="pre">noaa_stations.py</span></code> in a few steps:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># filename matches name given in plugins data definition</span>
<span class="kn">from</span> <span class="nn">systems.plugins.index</span> <span class="kn">import</span> <span class="n">BaseProvider</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">io</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Provider</span><span class="p">(</span><span class="n">BaseProvider</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;noaa_stations&quot;</span><span class="p">)):</span>
          <span class="c1"># Generate a parent class based on &#39;source&#39; and plugin definition</span>
          <span class="c1"># Three interface methods required: item_columns, load_items, load_item</span>
</pre></div>
</div>
<p>We do not have to use <em>requests</em>, <em>pandas</em>, <em>logging</em>, or <em>io</em>, but they are
particular modules that are useful in the methods below.  All we really need is
to define the class <code class="docutils literal notranslate"><span class="pre">Provider</span></code> which has a funny dynamic parent class defined
by passing names to the system class <code class="docutils literal notranslate"><span class="pre">BaseProvider</span></code>.  You need not think about
the metaclass magic underneath this, just copy the pattern.  Always include
“source” and the name you defined in <code class="docutils literal notranslate"><span class="pre">source.yml</span></code> as strings passed to
<code class="docutils literal notranslate"><span class="pre">BaseProvider</span></code>.</p>
<p>Now let us look at the methods we need:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">item_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># Return a list of header column names for source dataframe</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;station_id&quot;</span><span class="p">,</span> <span class="s2">&quot;station_name&quot;</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span>
            <span class="s2">&quot;temperature&quot;</span><span class="p">,</span> <span class="s2">&quot;temperature_attrs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">,</span> <span class="s2">&quot;elevation&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>This one is very simple.  All it does is return a list of string names for
fields, as we wish to spell them within Zimagi command line or API access.
Continuing, let us look at the simpler <code class="docutils literal notranslate"><span class="pre">load_item()</span></code> method next:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">load_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="c1"># Dataframe iterrows passes tuple of (index, object)</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># Return values list that maps to header elements in item_columns()</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">STATION</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">DATE</span><span class="p">,</span>
            <span class="kc">None</span> <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">TEMP</span> <span class="o">==</span> <span class="mf">9999.9</span> <span class="k">else</span> <span class="n">row</span><span class="o">.</span><span class="n">TEMP</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">TEMP_ATTRIBUTES</span><span class="p">,</span>
            <span class="n">row</span><span class="o">.</span><span class="n">LATITUDE</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">LONGITUDE</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">ELEVATION</span><span class="p">]</span>
</pre></div>
</div>
<p>The task of this method is to take a single <code class="docutils literal notranslate"><span class="pre">row</span></code> object and return a list of
values.  The <code class="docutils literal notranslate"><span class="pre">row</span></code> object can be anything whatsoever, as long as it lets us
figure out a collection of values to match up with the column names returned by
<code class="docutils literal notranslate"><span class="pre">item_columns</span></code>.  In this specific example, the object received is a tuple
containing an index and a Pandas Series (as we will see).  The index into the
underlying Pandas DataFrame is irrelevant to us, but the Series has everything
we care about.</p>
<p>To return a Python list of values, we mostly just access each record in the
Series, which at this point have names corresponding to the column names in the
source CSV files.  You can see that those are spelled a bit differently than
the names we prefer to use in our module (if nothing else, we do not want the
names in ALLCAPS), but the translation is obvious enough from their spelling.
We can also, of course, line up the index positions of the column names we used
with the items returned by the method.  In one case, we do some minor data
cleanup by marking the “missing data” sentinel of 9999.9 as explicitly None
(i.e. the Python <code class="docutils literal notranslate"><span class="pre">None</span></code>, which gets represented as <code class="docutils literal notranslate"><span class="pre">NULL</span></code> in the RDBMS). In
concept though, we could do whatever other calculation or substitution we wished
to within this method.</p>
</div>
<div class="section" id="loading-items">
<h3>1.2.3.4.2. Loading items<a class="headerlink" href="#loading-items" title="Permalink to this headline">¶</a></h3>
<p>The heavy lifting of this data import <code class="docutils literal notranslate"><span class="pre">Provider</span></code> class is performed in the
method <code class="docutils literal notranslate"><span class="pre">.load_items()</span></code>.  Of course, being Python code, we are free to define
whatever other methods might be useful to us within this class, as long as they
do not use these few reserved names:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">load_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="n">base_url</span> <span class="o">=</span> <span class="s2">&quot;https://www.ncei.noaa.gov/data/global-summary-of-the-day/access&quot;</span>
    <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_min_year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_max_year</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">year_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_station_ids</span><span class="p">:</span>
            <span class="c1"># Want all files for this year</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Only pull the list of station_ids given</span>
            <span class="k">for</span> <span class="n">station_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_station_ids</span><span class="p">:</span>
                <span class="n">station_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year_url</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">station_id</span><span class="si">}</span><span class="s2">.csv&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fetching data from </span><span class="si">{</span><span class="n">station_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">station_url</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pulled </span><span class="si">{</span><span class="n">station_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>
                    <span class="k">yield from</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Station </span><span class="si">{</span><span class="n">station_id</span><span class="si">}</span><span class="s2"> not present for </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The implementation shown here is partial.  It only accepts the case where
station IDs are explicitly provided.  We have yet to implement the common case
where we load “all stations matching the years given.”  To do that, we will have
to program a little bit of web scraping to read the directory at the base URL
and figure out which CSV files exist.</p>
<p>Bracketing the part not fleshed out, we see everything that is functionally
needed in the <code class="docutils literal notranslate"><span class="pre">else:</span></code> block.  We start at a base URL which we know, by
examination and by the documentation of the data source, contains subdirectories
named after years.  Moreover, we have indicated, in the <code class="docutils literal notranslate"><span class="pre">source.yml</span></code> file
discussed above, that the fields named <code class="docutils literal notranslate"><span class="pre">min_year</span></code> and <code class="docutils literal notranslate"><span class="pre">max_year</span></code> are
required to be present, and to be integers.  To use them within the Python code,
we prefix their names with <code class="docutils literal notranslate"><span class="pre">field_</span></code>.</p>
<p>This code loops over years matching the range defined by the fields, then uses
the <em>requests</em> module to determine whether a corresponding CSV URL exists. We
also log the status of what was done, which is useful but not required.</p>
<p>The essential operation of the <code class="docutils literal notranslate"><span class="pre">.load_items()</span></code> method is that it yields each
individual <code class="docutils literal notranslate"><span class="pre">row</span></code> object of the sort that <code class="docutils literal notranslate"><span class="pre">.load_item()</span></code> will consume.  That
concludes the Python code needed for this module.  What remains is entirely to
configure commands that the Zimagi runtime will use to utilize this Python code
(once combined with base scaffolding code behind the scenes).</p>
</div>
</div>
<div class="section" id="defining-commands">
<h2>1.2.3.5. Defining commands<a class="headerlink" href="#defining-commands" title="Permalink to this headline">¶</a></h2>
<p>The final step in being able to actually <em>use</em> the data objects we have
configured is define Zimagi commands to import their data and query them.  By
adding a <code class="docutils literal notranslate"><span class="pre">station</span></code> command, we automatically add a collection of subcommands
associated with querying data.</p>
<p>As elsewhere, we often wish to define a reusable <code class="docutils literal notranslate"><span class="pre">command_base</span></code> that might be
utilized by various commands to avoid repetition.  In this module, we define the
following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">command_base</span><span class="p">:</span>
  <span class="c1"># Define a base command with settings</span>
  <span class="c1"># Same name as data model by convention, not requirement</span>
  <span class="n">station_base</span><span class="p">:</span>
    <span class="n">class</span><span class="p">:</span> <span class="n">StationCommandBase</span>
    <span class="n">mixins</span><span class="p">:</span> <span class="p">[</span><span class="n">station</span><span class="p">]</span>
    <span class="c1"># Accessible via the API</span>
    <span class="n">server_enabled</span><span class="p">:</span> <span class="n">true</span>
    <span class="c1"># Only these groups can use &#39;station&#39; commands</span>
    <span class="n">groups_allowed</span><span class="p">:</span> <span class="p">[</span><span class="n">noaa</span><span class="o">-</span><span class="n">admin</span><span class="p">]</span>
</pre></div>
</div>
<p>The particular name we chose for this command base is anything we might wish,
but <code class="docutils literal notranslate"><span class="pre">station_base</span></code> seems like an obvious choice.  It has an (optional)
internal class name in the generated code, and it uses the mixin we discussed
earlier.  The two elements where we actually make design decisions are in that
we wish to expose commands based on this within the RESTful JSON API (i.e. for
web requrests), and that we want the role <code class="docutils literal notranslate"><span class="pre">noaa-admin</span></code> to be able to use it.</p>
<p>We need an actual command here.  To show that the names of the commands are
chosen by use, rather than constrained by the name of the data object or by
mixins, we defined too almost-synonyms.  Both <code class="docutils literal notranslate"><span class="pre">station</span></code> subcommands and
<code class="docutils literal notranslate"><span class="pre">bahnhof</span></code> subcommands will do the same thing (“Bahnhof” is simply a German
word for “station”):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">command</span><span class="p">:</span>
  <span class="n">station</span><span class="p">:</span>
    <span class="c1"># Maps back to data object</span>
    <span class="n">resource</span><span class="p">:</span> <span class="n">station</span>
    <span class="n">base</span><span class="p">:</span> <span class="n">station_base</span>
    <span class="c1"># Show later than core commands</span>
    <span class="n">priority</span><span class="p">:</span> <span class="mi">99</span>
    <span class="n">groups_allowed</span><span class="p">:</span> <span class="p">[</span><span class="n">noaa</span><span class="o">-</span><span class="n">admin</span><span class="p">,</span> <span class="n">admin</span><span class="p">]</span>

  <span class="c1"># Alternate command (does same thing to demonstrate)</span>
  <span class="n">bahnhof</span><span class="p">:</span>
    <span class="c1"># Maps back to data object</span>
    <span class="n">resource</span><span class="p">:</span> <span class="n">station</span>
    <span class="n">base</span><span class="p">:</span> <span class="n">station_base</span>
    <span class="c1"># Tie into object type (to match prefix for mixin)</span>
    <span class="c1"># I.e. match ref mixin_name</span>
    <span class="n">base_name</span><span class="p">:</span> <span class="n">station</span>
    <span class="c1"># Show later than core commands</span>
    <span class="n">priority</span><span class="p">:</span> <span class="mi">98</span>
</pre></div>
</div>
<p>The only differences here, other than the obvious spelling, is that we
demonstrate that a command may override its base; in this case we redefine
<code class="docutils literal notranslate"><span class="pre">groups_allowed</span></code> for the <code class="docutils literal notranslate"><span class="pre">station</span></code> command.  This is not a real change in
behavior since <em>admin</em> is always allowed to do everything anyway.  We also
choose slightly different <code class="docutils literal notranslate"><span class="pre">priority</span></code> values for the two spellings, which will
cause <code class="docutils literal notranslate"><span class="pre">bahnhof</span></code> to appear earlier than <code class="docutils literal notranslate"><span class="pre">station</span></code> when you run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@zimagi-noaa:~$ zimagi help
</pre></div>
</div>
<p>Inside the Vagrant shell.  As the module is configured now, the <code class="docutils literal notranslate"><span class="pre">observation</span></code>
priority is even higher (105), so appears after both.</p>
<div class="section" id="import-commands">
<h3>1.2.3.5.1. Import commands<a class="headerlink" href="#import-commands" title="Permalink to this headline">¶</a></h3>
<p>We have provided a <code class="docutils literal notranslate"><span class="pre">station</span></code> (or <code class="docutils literal notranslate"><span class="pre">bahnhof</span></code>) command as a place to put
subcommands we use in querying data.  But we need to define an <code class="docutils literal notranslate"><span class="pre">import</span></code>
subcommand to load the data from our remote source(s) into the local RDBMS.</p>
<p>For this module, we define that inside
<code class="docutils literal notranslate"><span class="pre">$ZDIR/lib/modules/default/noaa-stations/spec/import/station_observations.yml</span></code>.</p>
<p>This YAML file includes a new YAML feature we have not seen before.  Using
mixins and bases for commands and data models is a way of providing templates
for reuse.  As well, YAML itself has a feature for literal transclusion of
boilerplate.  This distinction is very similar to the difference between an
<code class="docutils literal notranslate"><span class="pre">#include</span></code> directive in languages like C/C++ and <em>inheritance</em> of classes in
languages like Python (or C++, or Java, etc).  For better or worse, because
<code class="docutils literal notranslate"><span class="pre">import</span></code> is a built-in Zimagi command, we can define subcommands but not new
bases or mixins for it.</p>
<p>The YAML feature we see is called <em>anchors</em> and <em>aliases</em>.  They always occur
in the same physical file, so are somewhat different from C-style <code class="docutils literal notranslate"><span class="pre">#include</span></code>
directives in that respect.  Let us look first at the anchor we use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">_observation</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">observation</span>
  <span class="n">source</span><span class="p">:</span> <span class="n">noaa_stations</span>
  <span class="n">data</span><span class="p">:</span>
    <span class="n">station</span><span class="p">:</span>
      <span class="nb">map</span><span class="p">:</span>
        <span class="c1"># &quot;number&quot; as defined in spec/data/station.yml</span>
        <span class="n">number</span><span class="p">:</span>
          <span class="c1"># &quot;station_id&quot; as defined in plugins/source/noaa_stations.py</span>
          <span class="n">column</span><span class="p">:</span> <span class="n">station_id</span>
        <span class="n">name</span><span class="p">:</span>
          <span class="n">column</span><span class="p">:</span> <span class="n">station_name</span>
        <span class="n">lat</span><span class="p">:</span>
          <span class="n">column</span><span class="p">:</span> <span class="n">latitude</span>
        <span class="n">lon</span><span class="p">:</span>
          <span class="n">column</span><span class="p">:</span> <span class="n">longitude</span>
        <span class="n">elevation</span><span class="p">:</span>
          <span class="n">column</span><span class="p">:</span> <span class="n">elevation</span>

    <span class="n">observation</span><span class="p">:</span>
      <span class="n">relations</span><span class="p">:</span>
        <span class="n">station_id</span><span class="p">:</span>
          <span class="c1"># Mapping back to &quot;station&quot; as defined in spec/data/station.yml</span>
          <span class="n">data</span><span class="p">:</span> <span class="n">station</span>
          <span class="c1"># Mapping back to plugins/source/noaa_stations.py</span>
          <span class="n">column</span><span class="p">:</span> <span class="n">station_id</span>
          <span class="n">required</span><span class="p">:</span> <span class="n">true</span>
      <span class="nb">map</span><span class="p">:</span>
        <span class="n">date</span><span class="p">:</span>
          <span class="n">column</span><span class="p">:</span> <span class="n">date</span>
        <span class="n">temp</span><span class="p">:</span>
          <span class="n">column</span><span class="p">:</span> <span class="n">temperature</span>
        <span class="n">temp_attrs</span><span class="p">:</span>
          <span class="n">column</span><span class="p">:</span> <span class="n">temperature_attrs</span>
</pre></div>
</div>
<p>This anchor is something we are likely to use as we develop more commands.  It
has an anchor name <code class="docutils literal notranslate"><span class="pre">&amp;observation</span></code>, but as we will see, when we <em>alias</em> it
we will spell that as <code class="docutils literal notranslate"><span class="pre">*observation</span></code> (these spelling are loosely inspired by
references and pointers in C/C++ family languages).  The name of the key with
a leading underscore, <code class="docutils literal notranslate"><span class="pre">_observation</span></code> is irrelevant—you can use any identifier
name you like, and it is not used again elsewhere; something merely needs to
occur there syntactically.</p>
<p>We indicate the source in terms of a <em>provider</em>. Recall the definition in
<code class="docutils literal notranslate"><span class="pre">spec/plugins/source.yml</span></code> that was discussed above; this is where the spelling
<code class="docutils literal notranslate"><span class="pre">noaa_stations</span></code> comes from.  Given that source, we define <code class="docutils literal notranslate"><span class="pre">data</span></code> import
elements <code class="docutils literal notranslate"><span class="pre">station</span></code> and <code class="docutils literal notranslate"><span class="pre">observation</span></code>.  These each have a <code class="docutils literal notranslate"><span class="pre">map</span></code> key that
maps database table column names to names used within the Zimagi shell and
API.  They might also have a <code class="docutils literal notranslate"><span class="pre">relations</span></code> key that defines a foreign-key
relationship.</p>
<p>The final component of our (simple) module is define an actual <code class="docutils literal notranslate"><span class="pre">import</span></code>
subcommand.  We can do that as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">import</span><span class="p">:</span>
  <span class="n">test</span><span class="p">:</span>
    <span class="c1"># Identical to including the body of _observation here</span>
    <span class="o">&lt;&lt;</span><span class="p">:</span> <span class="o">*</span><span class="n">observation</span>
    <span class="c1"># In concept we could override definition from reference, e.g.</span>
    <span class="c1"># source: something_else</span>
    <span class="n">tags</span><span class="p">:</span> <span class="p">[</span><span class="n">observations</span><span class="p">]</span>
    <span class="n">min_year</span><span class="p">:</span> <span class="mi">1929</span>
    <span class="n">max_year</span><span class="p">:</span> <span class="mi">1931</span>
    <span class="n">station_ids</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;03005099999&quot;</span><span class="p">,</span> <span class="s2">&quot;99006199999&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>The special key <code class="docutils literal notranslate"><span class="pre">&lt;&lt;</span></code> is the one that indicates an alias back to the anchor
defined above.  It is exactly as if we had typed the entire body of
<code class="docutils literal notranslate"><span class="pre">_observation</span></code> at that same point in the file</p>
<p>The key <code class="docutils literal notranslate"><span class="pre">tags</span></code> indicates <strong>[TODO]</strong>.</p>
<p>For this simple subcommand <code class="docutils literal notranslate"><span class="pre">test</span></code> we give a fixed value for a <code class="docutils literal notranslate"><span class="pre">min_year</span></code> and
<code class="docutils literal notranslate"><span class="pre">max_year</span></code>, and also a specific list of <code class="docutils literal notranslate"><span class="pre">station_ids</span></code> that we will import
from the NOAA website.  In a more flexible command, you would indicate these
elements using switches to a command, but this demonstrates the general pattern.</p>
<p>At this point—perhaps after running <code class="docutils literal notranslate"><span class="pre">zimagi</span> <span class="pre">module</span> <span class="pre">save</span> <span class="pre">noaa-stations</span></code> again,
if needed, we can run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@zimagi-noaa:~$  zimagi import test
</pre></div>
</div>
<p>Data is available locally to be queries from the Vagrant shell or the API now.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../environment.html" class="btn btn-neutral float-right" title="1.3. Zimagi Environment" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="docker.html" class="btn btn-neutral float-left" title="1.2.2. Dockerized Development" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Zimagi

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(false);
      });
  </script>

  
  
    
   

</body>
</html>